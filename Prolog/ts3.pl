:- dynamic(memo/3).
memo(_I,_J,-1073741824).

solvePru(_,H,_N,_M,_CF,-1073741824):-H < 0,!.

solvePru(_,_H,0,_M,_CF,0):-!.
solvePru(L,H,N,M,CF,R):- solveFila(L,-1073741824,H,N,M,1,CF,R).


solveFila([_|_],_,_,_,M,K,_,-1073741824):- K > M,!.

solveFila([_|_],_,_,0,_,_,_,0).
solveFila([_|_], _,H,_,_, _, CF,R):- memo(CF,H,R),R > 0,!.

solveFila([[Vf|Tf]|T],Vm,H,N,M,K,CF,R):- Vf >= 5,H1 is H - K,N1 is N - 1,CF1 is CF + 1,solvePru(T,H1,N1,M,CF1,Vs),
											V1 is Vf + Vs,maximo(V1,Vm,V2),K1 is K + 1,
											solveFila([Tf|T],V2,H,N,M,K1,CF,R1),maximo(V1,R1,R),asserta((memo(CF,H,R):-!)),!.
solveFila([[_|Tf]|T],Vm,H,N,M,K,CF,R):- K1 is K + 1,solveFila([Tf|T],Vm,H,N,M,K1,CF,R).

maximo(X,Y,X):- X >= Y.
maximo(_X,Y,Y).

%retractall(memo/3).

%solvePru2([[2,3,8,8,9,9,10,10,10,10,10,10],[7,8,8,9,10,10,10,10,10,10,10,10],[9,10,10,10,10,10,10,10,10,10,10,10],[1,2,2,8,10,10,10,10,10,10,10,10], [6,10,10,10,10,10,10,10,10,10,10,10]],5,12,5,12,R).

f([],[]).
f([[[N,M],L]|T],[R1|R2]):-ts([[N,M],L],R1), retractall(memo(X,Y,Z)), f(T,R2).

termStrat(R):- casos(X), f(X,R), printR(R).

printR([]):-!.
printR([H|T]):-H>0, !, format('Maximal possible average mark - ~2f.~n',[H]), printR(T).
printR([_|T]):-!, format('Peter, you shouldn\'t have played billiard that much.~n',[]), printR(T).

ts([[N,M],L], X):-solvePru(L,M,N,M,N,R), X is R/N.




casos([[[7,4],[[3,6,9,10],[5,10,10,10],[6,7,10,10],[7,9,9,9],[0,2,7,7],[5,5,10,10],[6,8,10,10]]],[[5,20],[[1,1,5,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[3,5,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[8,8,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[0,8,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[5,8,8,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[5,13],[[3,4,4,9,9,9,9,10,10,10,10,10,10],[7,10,10,10,10,10,10,10,10,10,10,10,10],[5,10,10,10,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[8,9],[[1,8,9,10,10,10,10,10,10],[4,4,7,9,9,10,10,10,10],[7,9,9,10,10,10,10,10,10],[1,7,8,9,10,10,10,10,10],[1,9,10,10,10,10,10,10,10],[5,5,9,10,10,10,10,10,10],[6,10,10,10,10,10,10,10,10],[2,9,10,10,10,10,10,10,10]]],[[8,12],[[10,10,10,10,10,10,10,10,10,10,10,10],[7,8,9,10,10,10,10,10,10,10,10,10],[6,6,10,10,10,10,10,10,10,10,10,10],[4,4,7,9,9,10,10,10,10,10,10,10],[6,7,9,9,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10,10],[5,8,9,9,10,10,10,10,10,10,10,10]]],[[8,11],[[2,3,4,4,5,5,8,10,10,10,10],[2,6,10,10,10,10,10,10,10,10,10],[9,9,9,9,9,9,10,10,10,10,10],[6,6,9,10,10,10,10,10,10,10,10],[0,0,10,10,10,10,10,10,10,10,10],[7,8,9,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10],[0,6,8,10,10,10,10,10,10,10,10]]],[[10,4],[[6,7,9,10],[6,6,10,10],[3,4,6,10],[7,10,10,10],[9,10,10,10],[3,9,9,9],[1,7,9,9],[6,10,10,10],[0,0,6,10],[1,9,10,10]]],[[2,13],[[6,8,8,10,10,10,10,10,10,10,10,10,10],[4,6,8,10,10,10,10,10,10,10,10,10,10]]],[[5,15],[[3,7,10,10,10,10,10,10,10,10,10,10,10,10,10],[6,7,9,9,9,9,10,10,10,10,10,10,10,10,10],[9,9,10,10,10,10,10,10,10,10,10,10,10,10,10],[0,0,2,8,8,9,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[1,8],[[6,10,10,10,10,10,10,10]]],[[2,14],[[3,6,9,9,10,10,10,10,10,10,10,10,10,10],[5,8,10,10,10,10,10,10,10,10,10,10,10,10]]],[[8,10],[[3,10,10,10,10,10,10,10,10,10],[6,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10],[0,3,7,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10],[1,6,6,10,10,10,10,10,10,10]]],[[6,17],[[2,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[6,6,8,9,10,10,10,10,10,10,10,10,10,10,10,10,10],[6,6,7,8,8,9,9,9,9,10,10,10,10,10,10,10,10],[4,6,6,6,10,10,10,10,10,10,10,10,10,10,10,10,10],[1,3,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[7,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[7,11],[[2,10,10,10,10,10,10,10,10,10,10],[6,6,9,9,10,10,10,10,10,10,10],[8,8,10,10,10,10,10,10,10,10,10],[2,7,9,10,10,10,10,10,10,10,10],[9,10,10,10,10,10,10,10,10,10,10],[1,6,7,9,10,10,10,10,10,10,10],[3,9,10,10,10,10,10,10,10,10,10]]],[[4,8],[[8,9,9,9,10,10,10,10],[1,5,10,10,10,10,10,10],[5,9,10,10,10,10,10,10],[6,7,10,10,10,10,10,10]]],[[10,10],[[5,7,10,10,10,10,10,10,10,10],[4,5,6,6,7,7,9,9,10,10],[5,6,6,8,9,9,10,10,10,10],[0,9,10,10,10,10,10,10,10,10],[0,7,7,10,10,10,10,10,10,10],[2,7,9,10,10,10,10,10,10,10],[1,4,10,10,10,10,10,10,10,10],[0,2,8,10,10,10,10,10,10,10],[9,9,10,10,10,10,10,10,10,10],[7,10,10,10,10,10,10,10,10,10]]],[[2,12],[[4,9,10,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10,10]]],[[5,1],[[5],[10],[3],[7],[1]]],[[2,19],[[6,8,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[3,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[10,2],[[1,9],[9,10],[4,7],[2,3],[2,4],[10,10],[8,10],[8,9],[4,9],[7,10]]],[[8,18],[[10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[3,7,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[5,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[6,8,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[4,5,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[7,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[0,8,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[6,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[10,13],[[3,4,10,10,10,10,10,10,10,10,10,10,10],[0,6,7,7,8,10,10,10,10,10,10,10,10],[0,2,7,10,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10,10,10],[9,9,9,9,9,10,10,10,10,10,10,10,10],[3,5,7,7,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10,10,10],[9,10,10,10,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10,10,10],[2,3,5,9,9,10,10,10,10,10,10,10,10]]],[[5,12],[[2,3,8,8,9,9,10,10,10,10,10,10],[7,8,8,9,10,10,10,10,10,10,10,10],[9,10,10,10,10,10,10,10,10,10,10,10],[1,2,2,8,10,10,10,10,10,10,10,10],[6,10,10,10,10,10,10,10,10,10,10,10]]],[[9,3],[[0,6,8],[3,4,5],[9,9,10],[8,8,9],[4,5,5],[3,6,9],[4,4,10],[7,7,8],[2,9,9]]],[[10,7],[[4,6,10,10,10,10,10],[6,6,7,7,8,9,10],[0,6,6,7,9,10,10],[3,9,10,10,10,10,10],[5,8,8,8,9,10,10],[6,10,10,10,10,10,10],[0,4,6,6,8,10,10],[0,7,10,10,10,10,10],[4,9,10,10,10,10,10],[4,9,10,10,10,10,10]]],[[6,10],[[2,5,6,6,7,10,10,10,10,10],[4,8,8,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10],[5,9,9,9,10,10,10,10,10,10],[8,10,10,10,10,10,10,10,10,10],[9,9,10,10,10,10,10,10,10,10]]],[[8,8],[[6,6,8,10,10,10,10,10],[8,10,10,10,10,10,10,10],[8,10,10,10,10,10,10,10],[5,6,9,9,9,9,9,10],[8,10,10,10,10,10,10,10],[4,9,9,9,10,10,10,10],[9,10,10,10,10,10,10,10],[1,5,10,10,10,10,10,10]]],[[9,11],[[1,2,4,4,6,9,10,10,10,10,10],[5,7,8,10,10,10,10,10,10,10,10],[0,1,9,9,9,10,10,10,10,10,10],[4,9,9,9,9,10,10,10,10,10,10],[0,6,9,10,10,10,10,10,10,10,10],[2,2,6,10,10,10,10,10,10,10,10],[1,7,10,10,10,10,10,10,10,10,10],[2,9,10,10,10,10,10,10,10,10,10],[3,8,9,10,10,10,10,10,10,10,10]]],[[5,2],[[1,5],[7,10],[4,5],[10,10],[0,9]]],[[7,18],[[0,8,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[5,8,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[6,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[2,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[8,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[4,7,8,8,8,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[1,9],[[0,6,9,9,10,10,10,10,10]]],[[8,4],[[7,7,7,10],[4,5,5,8],[4,8,10,10],[3,7,7,9],[3,6,6,6],[4,6,7,7],[3,9,9,10],[4,10,10,10]]],[[2,20],[[0,0,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[7,7,8,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[6,11],[[0,8,10,10,10,10,10,10,10,10,10],[9,10,10,10,10,10,10,10,10,10,10],[1,6,6,10,10,10,10,10,10,10,10],[5,10,10,10,10,10,10,10,10,10,10],[7,7,8,10,10,10,10,10,10,10,10],[3,5,8,9,10,10,10,10,10,10,10]]],[[1,6],[[1,4,7,8,10,10]]],[[2,3],[[5,5,7],[7,10,10]]],[[7,18],[[3,3,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[3,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[5,8,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[5,6,7,7,7,8,9,10,10,10,10,10,10,10,10,10,10,10],[7,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[5,6,6,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10],[0,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[6,14],[[8,9,9,9,10,10,10,10,10,10,10,10,10,10],[4,4,8,9,10,10,10,10,10,10,10,10,10,10],[3,6,10,10,10,10,10,10,10,10,10,10,10,10],[7,9,10,10,10,10,10,10,10,10,10,10,10,10],[8,9,9,10,10,10,10,10,10,10,10,10,10,10],[0,7,9,9,9,9,9,10,10,10,10,10,10,10]]],[[6,10],[[3,4,5,7,10,10,10,10,10,10],[6,8,8,8,10,10,10,10,10,10],[3,8,10,10,10,10,10,10,10,10],[4,4,10,10,10,10,10,10,10,10],[4,5,7,7,9,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10]]],[[4,3],[[1,10,10],[4,10,10],[7,9,10],[9,9,9]]],[[1,12],[[8,9,9,9,9,9,9,10,10,10,10,10]]],[[2,4],[[2,4,8,8],[1,3,9,9]]],[[6,7],[[9,9,10,10,10,10,10],[0,8,10,10,10,10,10],[8,9,9,10,10,10,10],[0,8,8,8,10,10,10],[8,9,9,10,10,10,10],[9,10,10,10,10,10,10]]],[[2,17],[[2,4,8,8,8,9,10,10,10,10,10,10,10,10,10,10,10],[7,8,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[6,19],[[2,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[7,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[2,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[4,6,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[1,5,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[8,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[1,15],[[2,9,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[3,14],[[9,10,10,10,10,10,10,10,10,10,10,10,10,10],[5,5,9,10,10,10,10,10,10,10,10,10,10,10],[8,8,8,10,10,10,10,10,10,10,10,10,10,10]]],[[3,13],[[8,10,10,10,10,10,10,10,10,10,10,10,10],[1,10,10,10,10,10,10,10,10,10,10,10,10],[9,9,9,10,10,10,10,10,10,10,10,10,10]]],[[2,2],[[5,8],[6,6]]],[[9,1],[[6],[4],[2],[7],[6],[9],[5],[2],[4]]],[[2,12],[[4,4,7,7,9,10,10,10,10,10,10,10],[6,7,9,10,10,10,10,10,10,10,10,10]]],[[5,4],[[4,8,8,10],[9,9,9,10],[2,6,9,10],[2,3,8,8],[4,10,10,10]]],[[3,17],[[1,8,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[6,6,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[8,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10]]],[[10,11],[[1,8,8,10,10,10,10,10,10,10,10],[0,4,6,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10],[4,5,10,10,10,10,10,10,10,10,10],[0,0,7,10,10,10,10,10,10,10,10],[0,5,8,8,10,10,10,10,10,10,10],[6,8,10,10,10,10,10,10,10,10,10],[9,10,10,10,10,10,10,10,10,10,10],[4,8,10,10,10,10,10,10,10,10,10],[4,5,10,10,10,10,10,10,10,10,10]]],[[8,17],[[6,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10],[1,3,3,3,3,9,10,10,10,10,10,10,10,10,10,10,10],[1,8,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[8,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[3,7,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10],[3,4,8,8,8,10,10,10,10,10,10,10,10,10,10,10,10],[6,6,7,7,7,9,9,10,10,10,10,10,10,10,10,10,10]]]]):-!.



%fa([[[N,M],L]|T]):-solve(L,M,N,M,N,R), !, fa(T).


%[[[4,15],[[0,3,5,7,10,10,10,10,10,10,10,10,10,10,10],[7,8,8,10,10,10,10,10,10,10,10,10,10,10,10],[1,8,9,9,9,9,10,10,10,10,10,10,10,10,10],[3,6,8,8,10,10,10,10,10,10,10,10,10,10,10]]],[[5,12],[[2,3,8,8,9,9,10,10,10,10,10,10],[7,8,8,9,10,10,10,10,10,10,10,10],[9,10,10,10,10,10,10,10,10,10,10,10],[1,2,2,8,10,10,10,10,10,10,10,10],[6,10,10,10,10,10,10,10,10,10,10,10]]]]
